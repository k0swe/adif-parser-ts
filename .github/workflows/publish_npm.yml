name: Publish
on:
  workflow_dispatch:
    inputs:
      newversion:
        description: 'Semantic Version Bump Type (major minor patch)'
        required: true
        default: 'patch'

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PAT }}

    steps:
      - name: Setup Node.js environment
        uses: actions/setup-node@v3.6.0
        with:
          node-version: '16'
          registry-url: 'https://registry.npmjs.org'

      - name: Checkout
        uses: actions/checkout@v3

      - name: Test & Build
        run: |
          npm ci
          npm run test:prod
          npm run build
          # npm will complain if the docs are modified
          git checkout ./docs

      - name: Version and publish to npm
        id: npm-bump
        uses: bcomnes/npm-bump@v2
        with:
          git_email: ${{ github.actor }}@users.noreply.github.com
          git_username: ${{ github.actor }}
          newversion: ${{ github.event.inputs.newversion }}
          push_version_commit: true 
          github_token: ${{ secrets.GH_PAT }} 
          npm_token: ${{ secrets.NPM_TOKEN }}

      - name: Create Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.npm-bump.outputs.release_tag }}
          release_name: ${{ steps.npm-bump.outputs.release_tag }}
